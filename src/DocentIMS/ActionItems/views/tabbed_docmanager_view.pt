<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n" i18n:domain="My.Addon" metal:use-macro="context/main_template/macros/master">
  <body>
    <metal:content-core fill-slot="content-core">
      <metal:block define-macro="content-core">

        <div class="white-background">
          <!-- first tab -->

          <div class="pat-autotoc autotabs" data-pat-autotoc="section:fieldset;levels:legend;">

            <!-- Show all Document types as separate tabs document_type=-->
            <!-- ${items} -->

            <fieldset tal:repeat="doctypes python: view.grouped_items_by_document_type()">
              <legend>${python: doctypes['document_type']}</legend >


              <table class="listing pat-datatables listing" data-pat-datatables="pageLength: 50">
                <thead>
                  <tr>
                    <th>Title </th>
                    <th>Creator</th>
                    <th>Type</th>
                    <th>Modified </th>
                    <th>Download</th>
                    <th>View</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  <tr tal:repeat="item python: doctypes['items']">
                    <td>
                      <a href="${item/absolute_url}">${item/Title}</a>
                    </td>
                    <td>${item/Creator}</td>
                    <td>${item/Type}</td>
                    <td>
                      <time class="pat-display-time" datetime="${python:context.modified().ISO()}" data-pat-display-time="output-format: Do MMMM YYYY">
                           ${item/modified}
                      </time>
                    </td>
                    <td>
                      <tal:condition tal:condition="item/file|None">

                        <tal:define tal:define="
                            filename item/file/filename;
                            extension python:filename.split('.')[-1];                            
                        ">

                          <a href="${item/absolute_url}/@@download/file">
                            <img src="++plone++DocentIMS.ActionItems/${extension}_icon.jpg" alt="${extension}-icon" width="25" height="25"/>
                            <!-- ${filename}--> Download</a>
                        </tal:define>
                      </tal:condition>
                    </td>
                    <td>
                      <tal:condition tal:condition="item/file|None">
                        <a alt="Open in Only Office" title="View" href="${item/absolute_url}/onlyoffice-view-file">
                          <img src="++plone++DocentIMS.ActionItems/icons/eye.svg" alt="view icon" width="25" height="25"/>
  
                         View</a>
                      </tal:condition>
                    </td>
                    <!-- <td>
                      <tal:condition tal:condition="item/file|None">                        
                        <a alt="Email file" title="Send" href="#someurl">
                            <img src="++plone++DocentIMS.ActionItems/icons/envelope-arrow-down.svg" alt="email icon" width="25" height="25"/>  
                         Send</a>
                      </tal:condition>
                    </td> -->
                    <td>
                      <tal:condition tal:condition="item/file|None">
                        <a href="#" class="open-email-dialog" data-item-url="${item/absolute_url}" title="Send">
                          <img src="++plone++DocentIMS.ActionItems/icons/envelope-arrow-up.svg" alt="email icon" width="25" height="25"/>
    Send
                        </a>
                      </tal:condition>

                      <!-- Modal -->
                      <div class="modal fade" id="emailDialog" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content p-3">
                            <div class="modal-header">
                              <h5 class="modal-title">Send file by email</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                              <form id="emailForm">
                                <div class="mb-3">
                                  <label for="emailRecipients" class="form-label">Recipient email(s)</label>
                                  <input type="text" class="form-control" id="emailRecipients" name="recipients" placeholder="e.g. user@example.com, another@example.com" required>
</div>
<input type="hidden" name="file_url" id="fileUrl">
                                    <button type="submit" class="btn btn-primary">Send Email</button>
                                  </form>
                                  <div id="emailStatus" class="mt-3"></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </td>

                      </tr>
                    </tbody>
                  </table>
                </fieldset>
              </div>
            </div>

            <SCRIPT>
        $(document).ready(function() {
          // When the send link is clicked
          $('.open-email-dialog').on('click', function(e) {
            e.preventDefault();
            const fileUrl = $(this).data('item-url');
            $('#fileUrl').val(fileUrl);
            $('#emailStatus').text('');
            $('#emailDialog').modal('show');
          });

          // Handle form submission
          $(document).on('submit', '#emailForm', function(e) {
            e.preventDefault();
            const recipients = $('#emailRecipients').val();
            const fileUrl = $('#fileUrl').val();
            $.ajax({
              url: '@send_email',
              type: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              data: JSON.stringify({
                to: recipients,         
                fileurl: fileUrl,     // URL of file 
              }),
              success: function(response) {
                console.log(response);
                $('#emailStatus').html('<div class="alert alert-success">Email sent successfully!</div>');
              },
              error: function(xhr) {
                console.error(xhr.responseText);
                $('#emailStatus').html('<div class="alert alert-danger">Error sending email.</div>');
              }
            });

          });
        });
            </SCRIPT>
          </metal:block>
        </metal:content-core>
      </body>
    </html>



    